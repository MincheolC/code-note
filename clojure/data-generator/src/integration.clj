(ns integration
  (:require [next.jdbc :as jdbc]
            [db :refer [execute! execute-one! ds]]))

(def uids [34
           47
           52
           53
           59
           68
           74
           77
           79
           80
           98
           103
           120
           128
           129
           142
           152
           194
           203
           231
           239
           255
           259
           298
           350
           361
           394
           430
           445
           450
           467
           478
           481
           544
           601
           615
           671
           677
           683
           690
           728
           729
           769
           770
           777
           797
           814
           841
           849
           868
           879
           888
           901
           904
           906
           937
           950
           973
           1035
           1042
           1081
           1084
           1117
           1120
           1131
           1146
           1173
           1177
           1194
           1196
           1316
           1355
           1378
           1416
           1462
           1482
           1484
           1528
           1535
           1536
           1542
           1606
           1626
           1706
           1710
           1735
           1748
           1769
           1807
           1828
           1851
           1897
           1898
           1978
           2020
           2043
           2084
           2097
           2128
           2156
           2204
           2207
           2209
           2215
           2225
           4197
           4331
           4370
           4375
           4377
           4403
           4408
           4608
           4773
           4951
           4993
           5036
           5110
           5228
           10288
           10342
           10487
           11299])
(def uuids [22
            24
            55
            57
            60
            61
            65
            81
            83
            92
            100
            102
            108
            110
            112
            113
            115
            118
            122
            123
            124
            136
            138
            140
            143
            146
            155
            167
            169
            170
            176
            183
            187
            199
            201
            204
            207
            210
            213
            224
            232
            234
            240
            254
            256
            260
            263
            266
            270
            272
            296
            297
            304
            312
            321
            322
            330
            331
            341
            349
            359
            366
            368
            379
            391
            395
            409
            412
            419
            428
            431
            438
            443
            446
            460
            464
            468
            474
            479
            485
            496
            503
            508
            520
            523
            534
            552
            555
            557
            572
            573
            592
            605
            606
            636
            637
            643
            670
            675
            698
            705
            711
            721
            723
            727
            741
            753
            757
            758
            760
            761
            765
            768
            775
            785
            789
            811
            812
            820
            827
            829
            833
            834
            853
            855
            857
            859
            863
            865
            880
            887
            889
            891
            895
            899
            903
            905
            909
            911
            913
            914
            920
            932
            939
            948
            957
            966
            979
            982
            983
            993
            994
            996
            1010
            1022
            1024
            1028
            1030
            1036
            1037
            1039
            1043
            1045
            1056
            1062
            1064
            1069
            1071
            1079
            1088
            1091
            1106
            1107
            1115
            1116
            1118
            1126
            1127
            1140
            1152
            1155
            1159
            1183
            1184
            1187
            1197
            1198
            1212
            1217
            1237
            1238
            1243
            1246
            1250
            1253
            1258
            1261
            1262
            1272
            1275
            1280
            1284
            1295
            1300
            1306
            1308
            1314
            1318
            1319
            1320
            1328
            1329
            1334
            1335
            1357
            1358
            1363
            1364
            1372
            1375
            1376
            1385
            1394
            1398
            1402
            1408
            1410
            1419
            1420
            1429
            1430
            1432
            1433
            1436
            1447
            1456
            1458
            1466
            1475
            1488
            1493
            1501
            1504
            1509
            1512
            1515
            1537
            1550
            1551
            1558
            1568
            1573
            1574
            1577
            1580
            1588
            1598
            1601
            1604
            1607
            1611
            1617
            1619
            1621
            1622
            1623
            1631
            1632
            1633
            1637
            1643
            1644
            1647
            1652
            1655
            1662
            1664
            1666
            1670
            1671
            1678
            1682
            1688
            1695
            1703
            1707
            1709
            1713
            1718
            1731
            1742
            1743
            1744
            1746
            1747
            1751
            1756
            1759
            1766
            1776
            1780
            1784
            1789
            1797
            1800
            1803
            1805
            1808
            1810
            1811
            1827
            1830
            1831
            1842
            1843
            1852
            1865
            1866
            1877
            1879
            1883
            1886
            1888
            1890
            1894
            1896
            1901
            1905
            1909
            1917
            1923
            1929
            1942
            1949
            1951
            1956
            1971
            1980
            1986
            1988
            2000
            2005
            2006
            2010
            2023
            2024
            2026
            2027
            2044
            2057
            2062
            2066
            2067
            2068
            2078
            2082
            2099
            2101
            2105
            2111
            2115
            2121
            2122
            2132
            2138
            2142
            2146
            2148
            2152
            2157
            2162
            2168
            2180
            2183
            2187
            2191
            2195
            2219
            2222
            2223
            2234
            2238
            2240
            2245
            2246
            2248
            2264
            2272
            2273
            2281
            2283
            2284
            2285
            2287
            2288
            4101
            4114
            4159
            4161
            4175
            4190
            4212
            4216
            4230
            4317
            4327
            4332
            4334
            4347
            4354
            4363
            4364
            4386
            4393
            4396
            4397
            4412
            4417
            4422
            4433
            4435
            4436
            4445
            4446
            4458
            4461
            4465
            4469
            4470
            4475
            4479
            4480
            4487
            4488
            4490
            4491
            4500
            4501
            4507
            4510
            4516
            4517
            4532
            4533
            4537
            4554
            4557
            4560
            4585
            4607
            4610
            4618
            4620
            4625
            4639
            4644
            4655
            4670
            4685
            4692
            4694
            4716
            4722
            4724
            4727
            4731
            4736
            4742
            4743
            4745
            4749
            4758
            4764
            4766
            4769
            4785
            4913
            4916
            4923
            4931
            4940
            4944
            4947
            4952
            4955
            4967
            4971
            4985
            4986
            4991
            4992
            4994
            4996
            4997
            5000
            5019
            5028
            5030
            5031
            5034
            5051
            5054
            5063
            5064
            5066
            5068
            5074
            5075
            5083
            5087
            5100
            5107
            5119
            5126
            5131
            5141
            5147
            5154
            5156
            5170
            5174
            5183
            5187
            5189
            5196
            5205
            5208
            5213
            5215
            5221
            5247
            5248
            5250
            5258
            5260
            5265
            5280
            5283
            5300
            5303
            5304
            5305
            5312
            5314
            5323
            5332
            5340
            5345
            5354
            5373
            5382
            10001
            10004
            10005
            10016
            10025
            10029
            10031
            10037
            10043
            10064
            10065
            10067
            10071
            10074
            10078
            10079
            10084
            10101
            10111
            10114
            10123
            10126
            10145
            10148
            10149
            10155
            10157
            10162
            10169
            10172
            10174
            10175
            10176
            10179
            10187
            10194
            10196
            10198
            10202
            10209
            10220
            10222
            10225
            10228
            10234
            10260
            10261
            10272
            10275
            10277
            10284
            10292
            10293
            10302
            10304
            10310
            10318
            10320
            10322
            10323
            10326
            10329
            10335
            10336
            10345
            10346
            10347
            10354
            10355
            10361
            10364
            10369
            10371
            10375
            10378
            10395
            10397
            10398
            10411
            10419
            10433
            10434
            10439
            10443
            10445
            10448
            10458
            10462
            10467
            10480
            10483
            10486
            10491
            10509
            10517
            10519
            10521
            10528
            10534
            10539
            10544
            10549
            10550
            10557
            10572
            10581
            10585
            10613
            10617
            10629
            10631
            10636
            10639
            10642
            10650
            10660
            10664
            10666
            10672
            10678
            10686
            10692
            10704
            10705
            10714
            10755
            10756
            10761
            10770
            10790
            10795
            10806
            10809
            10823
            10826
            10827
            10829
            10837
            10843
            10848
            10857
            10858
            10861
            10868
            10871
            10872
            10881
            10891
            10926
            10946
            10948
            10954
            10966
            10973
            10974
            10984
            10985
            10986
            10998
            10999
            11006
            11017
            11020
            11026
            11070
            11074
            11080
            11088
            11095
            11102
            11112
            11120
            11149
            11170
            11189
            11206
            11208
            11211
            11219
            11226
            11234
            11240
            11253
            11256
            11297
            11304
            11321
            11326
            11333
            11339
            11345
            11349
            11353
            11360
            11361
            11370
            11375
            11379
            11381])

(defn- select-buyers []
  (execute! ds {:select [:id]
                :from   :users
                :where  [:and
                         [:not-in :id uids]
                         [:= :role "buyer"]]} jdbc/unqualified-snake-kebab-opts))

#_(defn- select-buyers []
  (execute! ds {:select [:id]
                :from   :users
                :where  [:and
                         [:= :id 22]
                         [:= :role "buyer"]]} jdbc/unqualified-snake-kebab-opts))

(defn- select-user-deposit-is-null [user-id]
  (execute! ds {:select [:id :user_id :change_amount]
                :from   :user_deposit_changes
                :where  [:and
                         [:= :user_id user-id]
                         [:= :deposit]]
                :order-by [:id]} jdbc/unqualified-snake-kebab-opts))

(defn- select-last-user-deposit [user-id]
  (execute-one! ds {:select   :udc.deposit
                    :from     [[:user_deposit_changes :udc]]
                    :where    [:and
                               [:= :udc.user_id user-id]
                               [:<> :deposit nil]]
                    :order-by [[:udc.id :desc]]
                    :limit    1} jdbc/unqualified-snake-kebab-opts))

(defn- update-user-deposit! [{:keys [id deposit]}]
  (execute! ds {:update [:user_deposit_changes]
                :set {:deposit deposit}
                :where [:= :id id]} {}))

(defn- calculate-deposits [user-deposits]
  (when (seq user-deposits)
    (let [user-id (:user-id (first user-deposits))
          last-deposit (or (:deposit (select-last-user-deposit user-id)) 0)]

     (reduce (fn [acc m]
               (let [deposit (+ (:change-amount m)
                                (if (peek acc) (:deposit (peek acc)) last-deposit))]
                 (conj acc (assoc m :deposit deposit)))) [] user-deposits))))

(defn update-users-deposits! []
  (let [deposits (->> uuids
                      (map select-user-deposit-is-null)
                      (map calculate-deposits)
                      (apply concat))]
    (doseq [deposit deposits]
      (update-user-deposit! deposit))))

#_(defn temp []
  (->> uuids
       (map select-user-deposit-is-null)
       (map calculate-deposits)
       (apply concat)
       (map update-user-deposit!)))

(comment
  (select-user-deposit-is-null)
  (update-users-deposits!)
  (select-last-user-deposit 1747)

  (select-buyers))
